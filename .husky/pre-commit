#!/usr/bin/env sh

# Prisma schema ë³€ê²½ ê°ì§€
if git diff --cached --name-only | grep -q "prisma/schema.prisma"; then
  echo "ğŸ” Detected changes in prisma/schema.prisma"

  # ìƒˆë¡œìš´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
  NEW_MIGRATIONS=$(git diff --cached --name-status | grep "^A.*prisma/migrations/.*migration.sql$" | wc -l)

  if [ "$NEW_MIGRATIONS" -gt 0 ]; then
    echo "âœ… New migration files detected ($NEW_MIGRATIONS) - OK"
  else
    # ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜ì • í™•ì¸
    MODIFIED_MIGRATIONS=$(git diff --cached --name-status | grep "^M.*prisma/migrations/" | wc -l)

    if [ "$MODIFIED_MIGRATIONS" -gt 0 ]; then
      echo ""
      echo "âš ï¸  WARNING: Existing migration files were modified!"
      echo "Modified migrations can cause issues in other environments."
      echo ""
      echo "If this is intentional (hotfix), you can proceed."
      echo "Otherwise, create a NEW migration instead:"
      echo "  npx prisma migrate dev --name describe_your_change"
      echo ""
      read -p "Continue anyway? (y/N) " -n 1 -r
      echo
      if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
      fi
    else
      echo ""
      echo "âŒ ERROR: schema.prisma changed but no new migration files were added!"
      echo ""
      echo "Please run:"
      echo "  npx prisma migrate dev --name describe_your_change"
      echo ""
      echo "Then stage the new migration files and commit again."
      echo ""
      exit 1
    fi
  fi
fi

# Prisma schema ìœ íš¨ì„± ê²€ì‚¬
if git diff --cached --name-only | grep -q "prisma/"; then
  echo "ğŸ” Validating Prisma schema..."
  npx prisma validate || {
    echo ""
    echo "âŒ ERROR: Prisma schema validation failed!"
    echo ""
    exit 1
  }
  echo "âœ… Prisma schema is valid"
fi
